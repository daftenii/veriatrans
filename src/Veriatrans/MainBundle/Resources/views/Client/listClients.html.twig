{% extends '::base.html.twig' %}
{#{% block title %}Sharepay | {{ "settings"|trans }}{% endblock %}#}
{% block body %}
    <div class="row">&nbsp;
    </div>
    <div class="row">
        <div class="col-xs-12">
            <div class="box">
                <div class="box-header">
                    <div class="box-name">
                        <i class="fa fa-table"></i>
                        <span>{{ 'ClientList'|trans}}</span>
                    </div>
                    <div class="box-icons">
                        <a class="a">
                            <i class="fa fa-edit edit-datatable"></i>
                        </a>
                        <a class="collapse-link">
                            <i class="fa fa-chevron-up"></i>
                        </a>
                        <a class="expand-link">
                            <i class="fa fa-expand"></i>
                        </a>
                    </div>
                    <div class="no-move"></div>
                </div>
                <div class="box-content">
                    <table class="table beauty-table table-hover editable" id="client">
                        <thead>
                        <tr>
                            <th>{{ 'Nr'|trans }}</th>
                            <th>{{ 'CompanyName'|trans }}</th>
                        </tr>
                        </thead>
                        <tbody>

                        {#
                        {% for Key,EachClient in Clients %}
                        <tr>
                            <td>{{ EachClient.RegistrationNumber }}</td>
                            <td><input type="text" value="{{ EachClient.Model }}"></td>
                            <td><input type="text" value="{{ EachClient.VIN }}"></td>
                            <td><input type="text" value="{{ EachClient.CreatedDate }}"></td>
                            <td><input type="text" value="{{ EachClient.ITPDate }}"></td>
                            <td><input type="text" value="{{ EachClient.LicenceDate }}"></td>
                            <td><input type="text" value="{{ EachClient.RCADate }}"></td>
                            <td><input type="text" value="{{ EachClient.TachographDate }}"></td>
                            <td><input type="text" value="{{ EachClient.CMRDate }}"></td>
                        </tr>
                        {% endfor %}
#}
                        </tbody>
                    </table>
                    <input type="hidden" value="" name="InEditMode">
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    <script type="text/javascript">
        UpdatePath                      = '{{ path('json_update_client',{ 'id': '_id_' }) }}';
        RetrieveClientColumnsLengthPath = '{{ path('json_retrieve_client_columns_length') }}'
        DeletePath                      = '{{ path('json_delete_client',{'id':'_id_'}) }}';
        CreatePath                      = '{{ path('json_create_client') }}';
        RetrieveClient                  = '{{ path('json_list_clients') }}';
        EditDatatable                   = 'i.edit-datatable';
        EditMode                        = $('input[name="InEditMode"]');
        DataTableID                     = $('#client');

        $(function () {
            EditMode.val('');

            /*
             $('table.editable tbody td input').on('click',function(){
             setEditable('table.editable tbody',true,[0,2]);
             });
             */
            DataTableID.dataTable({
                "bServerSide": true,
                "sAjaxSource": RetrieveClient,
                "bFilter": false,
                "order": [[ 0, "desc" ]],
                "language": {
                    "emptyTable":     "{{ "DatatableEmpty"|trans }}",
                    "info":           "{{ "DatatableInfo"|trans }}",
                    "infoEmpty":      "{{ "DatatableInfoEmpty"|trans }}",
                    "infoFiltered":   "{{ "DatatableInfoFiltered"|trans }}",
                    "infoPostFix":    "",
                    "thousands":      ",",
                    "lengthMenu":     "{{ "DatatableLengthMenu"|trans }}",

                    "loadingRecords": "{{ "DatatableLoadingRecords"|trans }}",
                    "processing":     "{{ "DatatableProcessing"|trans }}",
                    "search":         "{{ "DatatableSearch"|trans }}",
                    "zeroRecords":    "{{ "DatatableZeroRecords"|trans }}",
                    "paginate": {
                        "first":      "{{ "DatatableFirst"|trans }}",
                        "last":       "{{ "DatatableLast"|trans }}",
                        "next":       "{{ "DatatableNext"|trans }}",
                        "previous":   "{{ "DatatablePrvious"|trans }}"
                    },
                    "aria": {
                        "sortAscending":  "{{ "DatatableSortAscending"|trans }}",
                        "sortDescending": "{{ "DatatableSortDescending"|trans }}"
                    }
                },
                "aoColumns": [{
                    "mData":"id"
                },{
                    "mData":"companyName"
                }],
                fnDrawCallback: function(object) {
                    var Table = 'table.editable';
                    var TableTbody = Table+' tbody';
                    var TableRows = $('tr',TableTbody).length+1;
                    var InEditMode = Boolean(EditMode.val());
                    var classHide = '';
                    if(!InEditMode){
                        classHide = 'hide';
                    }

                    var html = '<tr id="'+(TableRows)+'" order="'+(TableRows-1)+'" class="'+classHide+'">'+
                            '<td>&nbsp;<i class="fa fa-save"></i></td>'+
                            '<td style="position:relative;"><input type="text" value="" class="datatable-default-element-focused" name="1" style="position:absolute;"></td>'+
                            '</tr>';

                    $('table.editable tbody').append(html);
                    $('table.editable tbody tr').each(function( index ) {
                        var value = $(this).attr('id');
                        $(this).attr('id',parseInt(value)-1);
                    });
                    setEditable(TableTbody,[0]);
                    $(TableTbody+' .datatable-default-element-focused').trigger('click');
//                    $(TableTbody+' .datatable-default-element-focused').focus();
                    $.ajax({
                        //mimeType: 'text/html; charset=utf-8', // ! Need set mimeType only when run from local file
                        url: RetrieveClientColumnsLengthPath,
                        type: 'GET',
                        success: function(data) {
                            $.each(object.aoColumns, function( index, value ) {
                                var column = value.mData.toLowerCase();
                                $('thead th:nth-child('+(index+1)+')', Table).attr('data-length',data[column]);
                                $('thead th:nth-child('+(index+1)+')', Table).attr('data-column-name',column);
                                $('tr:last td:nth-child('+(index+1)+') input', TableTbody).attr('maxlength',data[column]);
                                var isDate = column.slice(-4) == 'date';
                                if(isDate){
                                    //'placeholder="DD-MM-YYYY" data-mask="date"'
                                    $('tr:last td:nth-child('+(index+1)+') input', TableTbody).attr('placeholder','DD-MM-YYYY');
                                    $('tr:last td:nth-child('+(index+1)+') input', TableTbody).attr('data-mask','date');
                                }
                            });
                            $("[data-mask='date']").mask("99-99-9999");
                        },
                        error: function (jqXHR, textStatus, errorThrown) {
                            alert(errorThrown);
                        },
                        dataType: "json",
                        async: true
                    });

                    if(InEditMode){
                        $('tr[role="row"]',TableTbody).mouseenter(function(){
                            $('td:first',this).prepend('<div class="delete" style="position:absolute; cursor:pointer;"><i class="fa fa-times-circle" style="color:red;"></i></div>');
                            $('div.delete',this).off('click');

                            $('div.delete',this).on('click',function(){
                                var id = $(this).parents('tr').attr('id');
                                if(confirm('{{ 'Confirm delete'|trans}}')){
                                    var DeletePath1 = DeletePath.replace("_id_", id);
                                    $.ajax({
                                        //mimeType: 'text/html; charset=utf-8', // ! Need set mimeType only when run from local file
                                        url: DeletePath1,
                                        type: 'DELETE',
                                        success: function(data) {
                                            if(data.success){
                                                $('tr[id="'+id+'"]',TableTbody).effect("highlight", {color:'red'}, 700);
                                                $('tr[id="'+id+'"]',TableTbody).hide( 700, function() {
                                                    $('tr[id="'+id+'"]',TableTbody).remove();
                                                    $("#client").dataTable()._fnAjaxUpdate();
                                                });
                                            }
                                        },
                                        error: function (jqXHR, textStatus, errorThrown) {
                                            alert(errorThrown);
                                        },
                                        dataType: "json",
                                        async: true
                                    });
                                }
                            });
                        })
                        $('tr[role="row"]',TableTbody).mouseleave(function(){
                            $('td div.delete').remove();
                        })
                    }
                },
                fnCreatedRow: function( nRow, aData, iDataIndex ) {
                    $(nRow).attr('id', aData.id+1);
                    $(nRow).attr('order', iDataIndex);
                }
            });
        })
    </script>
{% endblock javascripts %}